Looking for the Devil in the Details: Learning Trilinear Attention Sampling

Network for Fine-grained Image Recognition

Heliang Zheng1∗, Jianlong Fu2, Zheng-Jun Zha1†, Jiebo Luo3

1University of Science and Technology of China, Hefei, China

2Microsoft Research, Beijing, China

3University of Rochester, Rochester, NY

1zhenghl@mail.ustc.edu.cn, zhazj@ustc.edu.cn, 2jianf@microsoft.com, 3jluo@cs.rochester.edu

Abstract

Learning subtle yet discriminative features (e.g., beak
and eyes for a bird) plays a signiﬁcant role in ﬁne-grained
image recognition. Existing attention-based approaches lo-
calize and amplify signiﬁcant parts to learn ﬁne-grained
details, which often suffer from a limited number of parts
and heavy computational cost. In this paper, we propose
to learn such ﬁne-grained features from hundreds of part
proposals by Trilinear Attention Sampling Network (TASN)
in an efﬁcient teacher-student manner. Speciﬁcally, TASN
consists of 1) a trilinear attention module, which generates
attention maps by modeling the inter-channel relationship-
s, 2) an attention-based sampler which highlights attended
parts with high resolution, and 3) a feature distiller, which
distills part features into an object-level feature by weight
sharing and feature preserving strategies. Extensive exper-
iments verify that TASN yields the best performance under
the same settings with the most competitive approaches, in
iNaturalist-2017, CUB-Bird, and Stanford-Cars datasets.

1. Introduction

Fine-grained visual categorization (FGVC) focuses on
distinguishing subtle visual differences within a basic-level
category (e.g., bird [1, 34] and car [13, 20, 36]). Al-
though the techniques of convolutional neural network (C-
NN) [8, 15, 25] for general image recognition [14, 23] have
become increasingly practical, FGVC is still a challenging
task where discriminative details are too subtle to be well-
represented by traditional CNN. Thus the majority of effort-
s in the ﬁne-grained community focuses on learning better
representation for such subtle yet discriminative details.

Existing attention/part-based methods [2, 7, 33, 40] try
to solve this problem by learning part detectors, cropping

∗This work was performed when Heliang Zheng was visiting Microsoft

Research as a research intern.

†Corresponding author.

Figure 1. An illustration of learning discriminative details by TAS-
N for a “bule jay.” As shown in (b), TASN learns such subtle
details by up-sampling each detail into high-resolution. And the
white concentric circles in (c) indicates ﬁne-grained details.

and amplifying the attended parts, and concatenating part
features for recognition. Although promising performance
has been achieved, there are several critical issues in such
a pipeline. Speciﬁcally, 1) the number of attention is lim-
ited and pre-deﬁned, which restricts the effectiveness and
ﬂexibility of the model. 2) Without part annotations, it is
difﬁcult to learn multiple consistent (i.e., attending on the
same part for each sample) attention maps. Although a
well-designed initialization [7, 16, 40] can beneﬁt the mod-
el training, it is not robust and cannot handle the cases with
uncommon poses. Moreover, 3) training CNNs for each
part is not efﬁcient. Such problems evolve as bottlenecks
for the study on attention-based methods.

To address the above challenges, we propose a trilin-
ear attention sampling network (TASN) which learns ﬁne-
grained details from hundreds of part proposals and efﬁ-
ciently distills the learned features into a single convolu-

5012

tional neural network. The proposed TASN consists of a
trilinear attention module, an attention-based sampler, and
a feature distiller. First, the trilinear attention module takes
as input feature maps and generates attention maps by self-
trilinear product, which integrates feature channels with
their relationship matrix. Since each channel of feature
maps is transformed into an attention map, hundreds of part
proposals can be extracted. Second, attention-based sam-
pler takes as input an attention map as well as an image, and
highlights attended parts with high resolution. Speciﬁcally,
for each iteration, the attention-based sampler generates a
detail-preserved image based on a randomly selected atten-
tion map, and a structure-preserved image based on an aver-
aged attention map. The former learns ﬁne-grained feature
for a speciﬁc part, and the latter captures global structure
and contains all the important details. Finally, A part-net
and a master-net are further formulated as “teacher” and “s-
tudent,” respectively. Part-net learns ﬁne-grained features
from the detail-preserved image and distills the learned fea-
tures into master-net. And the master-net takes as input the
structure-preserved image and reﬁnes a speciﬁc part (guid-
ed by the part-net) in each iteration. Such distillation is
achieved by weight sharing and feature preserving strate-
gies. Note that we adopt knowledge distilling introduced in
[10] instead of concatenating part features, because the part
number is large and not pre-deﬁned.

Since the feature distiller transfers the knowledge from
part-net into master-net via optimizing the parameters, 1) s-
tochastic details optimization (i.e., randomly optimize one
part in each iteration) can be achieved, which makes it prac-
tical to learn details from hundreds of part proposals, and 2)
efﬁcient inference can be obtained as we can use master-net
to perform recognition in the testing stage. To the best of
our knowledge, this work makes the ﬁrst attempt to learn
ﬁne-grained features from hundreds of part proposals and
represent such part features with a single convolutional neu-
ral network. Our contributions are summarized as follows:
• We propose a novel trilinear attention sampling net-
work (TASN) to learn subtle feature representations
from hundreds of part proposals for ﬁne-grained im-
age recognition.

• We propose to optimize TASN in a teacher-student
manner, in which ﬁne-grained features can be distilled
into a single master-net with high-efﬁciency.

• We conduct extensive experiments on three challeng-
ing datasets (iNaturalist, CUB Birds and Stanford
Cars), and demonstrate that TASN outperforms part-
ensemble models even with a single stream.

The remainder of the paper is organized as follows. We
describe related work in Section 2, and introduce our pro-
posed TASN model in Section 3. An evaluation on three
widely-used datasets is presented in Section 4, followed by
conclusions in Section 5.

2. Related Works

Attention Mechanism: As subtle yet discriminative de-
tails play an important role for Fine-Grained Image Recog-
nition,
learning to attend on discriminative parts is the
most popular and promising direction. Thus various of
attention mechanisms have been proposed in recent years
[7, 19, 26, 35, 40]. DT-RAM [19] proposed a dynamic com-
putational time model for recurrent visual attention, which
can attend on the most discriminative part in dynamic steps.
RA-CNN [7] proposed a recurrent attention convolutional
neural network to recurrently learn attention maps in multi-
ple (i.e., 3) scales. And MA-CNN [40] takes one step fur-
ther to generate multiple (i.e., 4) consistency attention maps
in a single scale by designing a channel grouping module.
However, the attention numbers (i.e., 1, 3, 4, respectively)
are pre-deﬁned, which counts against the effectiveness and
ﬂexibility of the model.

Meanwhile, high-order attention methods are proposed
in visual question answering (VQA) and video classiﬁca-
tion. Speciﬁcally, BAN [12] proposed a bilinear attention
module to handle the relationship between image region-
s and the words in question, and Non-local [30] calculates
the dot production of features to represent the spatial and
temporary relationship in video frames. Different from
these works, our trilinear attention module conducts bilinear
pooling to obtain the relationship among feature channels,
which is further utilized to integrate such features to obtain
third-order attention maps.

Adaptive Image Sampling: To preserve ﬁne-grained
details for recognition, high input resolution (448 × 448 v.s.
224 × 224) is widely adopted [5, 33, 40] and it can signif-
icantly improve the performance [5]. However, high reso-
lution brings large computational cost. More importantly,
the importance of different regions are various, while di-
rectly zooming in images cannot promise different region-
s with different resolutions. STN [11] proposed a non-
uniformed sampling mechanism which performs well on
MNIST datasets [17]. But without explicit guidance, it is
hard to learn non-uniformed sampling parameters for so-
phisticated tasks such as ﬁne-grained recognition, thus they
ﬁnally learned two parts without non-uniformed sampling.
SSN [22] ﬁrstly proposed to use saliency maps as the guid-
ance of non-uniformed sampling and obtained signiﬁcant
improvements. Different from them, our attention sampler
1) conduct non-uniformed sampling based on trilinear at-
tention maps, and 2) decomposes attention maps into two
dimensions to reduce spatial distortion effects.

Knowledge Distilling: Knowledge distilling is ﬁrstly
proposed by Hinton et al. [10] to transfer knowledge from
an ensemble or from a large highly regularized model into a
smaller, distilled model. The main idea is using soft target-
s (i.e., the predicted distribution of ensemble/large model)
to optimize the small model, for it contains more informa-

5013

Figure 2. Overview of the proposed Trilinear Attention Sampling Network (TASN). The trilinear attention module in (b) takes as input
convolutional feature maps (denoted as “conv”), and generates attention maps (denoted as “att”). The attention sampling module in (c)
further takes as input an attention map as well as the original image to obtain sampled images. Speciﬁcally, average pooling and random
selection (in each iteration) are conducted over attention maps to obtain structure preserved image in (d) and detail preserved image in
(e), respectively. The part-net (in green) learns ﬁne-grained features from (e) and generates a soft target to distill such features into the
master-net (in blue) via soft target cross entropy [10]. [Best viewed in color]

tion than the one-hot label. Such a simple yet effective idea
inspires many researchers and has been further studied by
[9, 38]. In this paper, we adopt this technique to distill the
learned details from part-net into master-net.

3. Method

In this section, we introduce the proposed Trilinear At-
tention Sampling Network (TASN), which is able to rep-
resent rich ﬁne-grained features by a single convolutional
neural network. TASN contains three modules, i.e., a trilin-
ear attention module for details localization, an attention-
based sampler for details extraction, and a feature distiller
for details optimization.

An overview of the proposed TASN is shown in Figure 2.
Given an input image in (a), we ﬁrst take it through several
convolutional layers to extract feature maps, which is fur-
ther transformed into attention maps by the trilinear atten-
tion module in (b). To learn ﬁne-grained features for a spe-
ciﬁc part, we randomly select an attention map and conduct
attention sampling over the input image using the selected
attention map. The sampled image in (e) is named as detail-
preserved image since it can preserve a speciﬁc detail with
high resolution. Moreover, to capture global structure and
contain all the important details, we average all the attention
maps and again conduct attention sampling, such a sampled
image in (d) is called structure-preserved image. We further
formulate a part-net to learn ﬁne-grained representation for
detail-preserved images, and a master-net to learn the fea-
tures for the structure-preserved image. Finally, the part-net
generates soft targets to distill the ﬁne-grained features into
master-net via soft target cross entropy [10].

3.1. Details Localization by Trilinear Attention

In this subsection, we introduce our trilinear attention
module, which transfers convolutional feature maps into at-
tention maps. As shown in previous work [24, 39], each
channel of the convolutional features corresponds to a vi-
sual pattern, however, such feature maps cannot act as at-
tention maps due to the lack of consistency and robustness
[32, 40]. Inspired by [40], we transform feature maps in-
to attention maps by integrating feature channels according
to their spatial relationship. Note that such a process can
be implemented in a trilinear formulation, thus we call it
trilinear attention module.

Given an input image I, we extract convolutional fea-
tures by feeding it into multiple convolutional, batch nor-
malization, ReLU, and pooling layers. Speciﬁcally, we use
resnet-18 [8] as backbone. To obtain high-resolution feature
maps for precise localization, we remove the two down-
sampling processes from original resnet-18 by changing
convolutional stride. Moreover, to improve the robustness
of convolutional response, we increase the ﬁeld of views [3]
by appending two sets of dilated convolutional layers with
multiple dilate rates. In the training stage, we added a soft-
max classiﬁer to optimize such convolutional features.

Assume that the feature maps is a tube with a dimension
of c × h × w, where c, h and w indicate channel number-
s, height, and width respectively. We reshape this feature
into a matrix with a shape of c × hw, which is denoted as
X ∈ Rc×hw. Then our trilinear function can be basically
formulated as:

Mb(X) := (XXT)X,

(1)

where XXT is the bilinear feature, which indicates the s-

5014

RR

c

hw

X

h
w

c

X

TX

TXX

TXX X

TXX

TXX X

c
c

2
2

1
1

c
c

2
2

1
1

RR reshape
R reshape

transpose
transpose
dot product
dot product

c
c
c

2
2
2

1
1
1

Figure 3. An illustration the trilinear product. X indicates con-
volutional feature maps, and we can obtain inter-channel relation-
ships by XXT. After that, we integrate each feature map with
its related ones to get trilinear attention maps via conducting dot
production over XXT and X.

patial relationship among channels. Speciﬁcally, Xi is the
ith channel of feature maps, and XXT
i,j indicates the spa-
tial relationship between channel i and channel j. To make
feature maps more consistency and robust, we further inte-
grate spatial relationship into feature maps by conducting
dot production over XXT and X, thus trilinear attention
maps can be obtained (which is shown in Figure 3).

We further studied different normalization methods to
improve the effectiveness of trilinear attention, and a de-
tailed discussion can be found in Section 4.2. To the end,
we adopt the following normalized trilinear attention:

M(X) := N (N (X)XT)X,

(2)

where N (·) indicates sof tmax normalization over the sec-
ond dimension of a matrix. Note that these two normaliza-
tion functions have different meanings: The ﬁrst one N (X)
is spatial normalization which keeps each channel of fea-
ture maps within the same scale. And the second one is re-
lationship normalization which is conducted over each re-
lationship vector (N (X)XT)i. We denote the output of
the trilinear function in Equation 2 as M ∈ Rc×hw, i.e.,
M = M(X). Finally, we reshape M into the shape of
c × h × w, thus each channel of M indicates an attention
map Mi ∈ Rh×w.

3.2. Details Extraction by Attention Sampling

In this subsection, we introduce our attention-based sam-
pler, which takes as input an image as well as trilinear atten-
tion maps, and generates a structure-preserved image and
a detail-preserved image. The structure-preserved image
captures the global structure and contains all the importan-
t details. Compared to the original image, the structure-
preserved one removed the regions without ﬁne-grained de-
tails, thus the discriminative parts can be better represented
with high resolution. The detail-preserved image focuses on
a single part, which can preserve more ﬁne-grained details.
Given an image I, we obtain structure-preserved im-
age Is and detail-preserved image Id by conducting non-

uniform sampling over different attention maps:

Is = S(I, A(M)),

Id = S(I, R(M)),

(3)

where M is the attention maps, S(·) indicates the non-
uniform sampling function, A(·) indicates average pool-
ing over channels, and R(·) indicates randomly selecting
a channel from the input. We calculate the average of all
attention maps to guide structure-preserved sampling, be-
cause such an attention map takes all the discriminative
parts into consideration. And we randomly select one at-
tention map for detail-preserved sampling, thus it can pre-
serve the ﬁne-grained details of this attended area with high
resolution. With the training process going on, all atten-
tion maps have the opportunity to be selected, thus different
ﬁne-grained details can be asynchronously reﬁned.

Our basic idea for attention-based sampling is consider-
ing the attention map as probability mass function, where
the area with large attention value is more likely to be sam-
pled. Inspired by the inverse-transform [6], we implement
the sampling by calculating the inverse function of the dis-
tribution function. Moreover, we decompose attention maps
into two dimensions to reduce spatial distortion effects.

Taking structure-preserved sampling for example, we
ﬁrst calculate the integral of the structure-preserved atten-
tion map A(M) over x and y axis:

Fx(n) :=

Fy(n) :=

n

X

j=1

n

X

i=1

max
1≤i≤w

A(M)i,j,

max
1≤j≤h

A(M)i,j,

(4)

where w and h are the width and height of the attention
map, respectively. Note that we use max(·) function to de-
compose the attention map into two dimensions, because it
is more robust than the alternative sum(·). We can further
obtain the sampling function by:

S(I, A(M))i,j = I

F −1

x (i),F −1

y (j).

(5)

where F −1(·) indicates the inverse function of F(·). In a
word, the attention map is used to calculate the mapping
function between the coordinates of the original image and
the sampled image.

Such a sampling mechanism is illustrated in Figure 4.
Given an attention map in (a), we ﬁrst decompose the map
into two dimensions by calculating the max values over x
axis (b1) and y axis (b2). Then the integral of (b1) and (b2)
are obtained and shown in (c1) and (c2), respectively. We
further calculate the inverse function of (c1) and (c2) in a
digital manner, i.e., we uniformly sample points over the y
axis, and follow the red arrow (shown in (c1) and (c2)), and
the blue arrow to obtain the values over x axis. (d) shows the

5015

Table 1. Detailed statistics of the three datasets used in this paper.

Dataset

# Class

# Train

# Test

CUB-200-2011 [34]

Stanford-Car [13]

iNaturalist-2017 [27]

200
196
5,089

5,994
8,144

579,184

5,794
8,041
95,986

where Lcls represents the classiﬁcation loss function, y is
a one hot vector which indicates the class label and λ de-
notes loss weight of the two terms. The soft target cross en-
tropy aims to distill the learned feature for ﬁne-grained de-
tails and transfer such information to the master-net. As the
attention-based sampler randomly select one part in each
iteration, all the ﬁne-grained details can be distilled to the
master-net in training process. Note that the convolutional
parameters are shared for part-net and master-net, which is
important for distilling, while the sharing of fully connected
layers is optional.

4. Experiments

4.1. Experiment setup

Datasets: To evaluate the effectiveness of our pro-
posed TASN, we conducted experiments on three exten-
sive and competitive datasets, namely Caltech-UCSD Birds
(CUB-200-2011) [34], Stanford Cars [13] and iNaturalist-
2017[27], respectively. The detailed statistics with catego-
ry numbers and the standard training/testing splits can be
found in Table 1. iNaturalist-2017 is the largest dataset for
the ﬁne-grained task. Compared with other datasets for this
task, it contains 13 superclasses. Such a data distribution
can provide a more convincing evaluation for the general-
ization ability of a model.

Baselines: We compared our method to the following
baselines due to their state-of-the-art performance and high
relevance. Note that for a fair comparison, we did not in-
clude methods using 1) additional data (from the web or
other datasets), 2) human-annotated part locations and 3)
hierarchical labels (i.e., species, genus, and family). And
all of the compared methods in each table share the same
backbone unless speciﬁed otherwise.

• FCAN [21]: Fully convolutional attention network,
which adaptively selects multiple attentions by rein-
forcement learning.

• MDTP [31]: Mining discriminative triplets of patch-
es, which utilize geometric constraints to improve the
accuracy of patch localization.

• DT-RAM [19]: Dynamic computational time model
for recurrent visual attention, which attends on the
most discriminative parts by dynamic steps.

• SSN [22]: Saliency-based sampling networks, which
conduct non-uniformed sampling based on saliency
map in an end-to-end way.

5016

Figure 4. An example of attention-based non-uniform sampling.
(a) is an attention map with Gaussian distribution. (b1) and (b2)
are the marginal distributions over x and y axis, respectively. (c1)
and (c2) are the integrals of marginal distributions. (d) shows the
sampling points by the blue dot, and (e) illustrates the sampled
image. [Best viewed in color with zoom-in.]

sampling points by blue dots, and we can observe that the
regions with large attention values are allocated with more
sampling points. Finally, (e) shows the result of the sampled
image. Note that the example in Figure 4 is a structure-
preserved sampling case.

3.3. Details Optimization by Knowledge Distilling

In this subsection, we introduce our details distiller,
which takes as input a detail-preserved image and a
structure-preserved image, and transfers the learned details
from part-net to master-net in a teacher-student manner.

Speciﬁcally, for each iteration, the attention-based sam-
pler introduced in Section 3.2 can provide a structure-
preserved image (denoted as Is) and a detail-preserved one
(denoted as Id). We ﬁrst obtain the fully connected (fc) out-
puts by feeding these two images into the same backbone
CNN (e.g., Resnet-50 [8]). The fc outputs are denoted as
zs and zd, respectively. Then the “softmax” classiﬁer con-
verts zs and zd into a probability vector qs and qd, which
indicates the predicted probability over each class. Taking
zs for example:

q(i)
s =

exp(z(i)

s /T )
Pj exp(z(j)

s /T )

,

(6)

where T is a parameter namely temperature, which is nor-
mally set to 1 for classiﬁcation tasks. While in knowledge
distilling, a large value for T is important as it can produce
a soft probability distribution over classes. We obtain the
soft target cross entropy [10] for the master-net as:

Lsof t(qs, qd) = −

N

X

i=1

q(i)
d logq(i)
s ,

(7)

where N denotes the class number. Finally, the objective
function of the master-net can be drived by:

L(Is) = Lcls(qs, y) + λLsof t(qs, qd),

(8)

Table 2. Ablation experiments on attention module in terms of
recognition accuracy on the CUB-200-2011 dataset.

Table 3. Ablation experiments on sampling module in term of clas-
siﬁcation accuracy on the CUB-200-2011 dataset.

Attention

Description

Accuracy

Approach

master-net

TASN

X

XXTX

feature maps

trilinear attention

N (X)XTX

N (X)N (X)TX

N (XXTX)
N (XXT)X

spacial norm
spacial norm
spacial norm
relation norm

N (N (X)XT)X spacial + relation

83.5
84.9
85.2
84.3
84.5
85.0
85.3

• MG-CNN [29]: Multiple granularity descriptors,
which leverage the hierarchical labels to generate com-
prehensive descriptors.

• STN [11]: Spatial transformer network, which con-
ducts parameterized spatial transformation to obtain
zoomed in or pose normalized objects.

• RA-CNN [7]: Recurrent attention CNN, which recur-

rently attends on discriminative parts in multi-scale.

• MA-CNN [40]: Multiple attention CNN, which at-
tends on multiple parts by their proposed channel
grouping module in a weakly-supervised way.

• MAMC [26]: Multi-attention multi-class constrain-
t network, which learns multiple attentions by conduct-
ing multi-class constraint over attended features.

• NTSN [37]: Navigator-Teacher-Scrutinizer Network,
which is a novel self-supervision mechanism to effec-
tively localize informative regions without the need of
bounding-box/part annotations.

• iSQRT-COV [18]: Towards faster training of global
covariance pooling networks by iterative matrix square
root normalization.

Implementation: We used open-sourced MXNet [4] as
our code-base, and trained all the models on 8 Tesla P-100
GPUs. The backbones are are pre-trained on Imagenet [23],
and all of the performances are single-crop testing result-
s for a single model unless specially stated. We used S-
GD optimizer without momentum and weight decay, and
the batch size was set to 96. The temperature in Equa-
tion 6 is 10, and the loss weight λ in Equation 8 is 2.
More implementation details can be referred to our code
https://github.com/researchmm/tasn.

4.2. Evaluation and analysis on CUB 200 2011

Trilinear attention. Table 2 shows the impact of dif-
ferent normalization functions for the part-net in term of
recognition accuracy. Speciﬁcally, we randomly select a
channel of attention maps in each iteration in training stage,
and conduct average pooling over attention maps for test-
ing. All the models use Resnet-50 as the backbone with
an input resolution of 224. It can be observed that trilin-
ear attention maps can signiﬁcantly outperform the original

Resnet-50 [8]

uniformed sampler
sampler in SSN [22]

our sampler

81.6
84.1
84.8
85.5

81.6
85.8
85.3
87.0

Table 4. Ablation experiments on distilling module with different
input resolutions.

Resolution

Resnet-50 [8]

master-net

TASN

224

81.6
85.5
87.0

280

83.3
86.6
87.3

336

85.0
87.0
87.9

392

85.6
86.8
87.9

feature maps. Both the attention functions of N (X)XTX
and N (XXT)X can improve the gain of trilinear attention.
N (X)N (X)TX and N (XXTX) bring a drop of perfor-
mance, because such normalization functions is harmful for
preserving spatial information. To this end, we adopt the
last setting (of Table 2) in our TASN. Note that in the ter-
m N (X)XT, N (X) indicates the region that a channel is
focusing on and XT denotes the feature of that region.

We further compared our trilinear attention module with
“self-attention” [28]. Speciﬁcally, we followed [28] to ob-
tain attention maps by XTX, and the results show that
the trilinear attention module can outperform self-attention
module with 0.7% points increases.

Attention-based sampler. To demonstrate the effective-
ness of our attention-based sampling mechanism, we com-
pared our sampling mechanism with 1) uniformed sampling
(by binarizing the attention maps) and 2) sampling oper-
ation introduced in SSN [22]. We set the input attention
maps to be same when comparing sampling mechanisms,
and experiments were conducted on two cases, i.e., with
and without part-net. All the models use Resnet-50 as the
backbone and the input resolution is set to 224. The result
in Table 3 shows that our sampling mechanism remarkably
outperforms the baselines. SSN sampler obtains a better re-
sult than uniformed sampler without part-net, while the fur-
ther improvements are limited when added part-net. These
observations show that the spatial distortion caused by SSN
sampler is harmful for preserving subtle details.

Knowledge distilling. Table 4 reveals the impact of de-
tails distilling module with different input resolutions. We
can observe consistency improvements by details distilling.
The performance of Resnet-50 [8] is saturated with 85.6%,
and 448 input can not further improve the accuracy. Without
distiller (i.e., master-net only), the performance is slightly
dropped with 392 input (compared to 336 input), since it
is difﬁcult to optimize each detail with large feature reso-

5017

Figure 5. A comparison of feature maps X in (a) and trilinear attention maps N (N (X)XT)X in (b). Each column shows the same channel
of feature maps and trilinear attention maps, and we randomly select nine channels for comparison. Compared to ﬁrst-order feature maps,
each channel of the trilinear attention maps focus on a speciﬁc part, without attending on background noises. [Best viewed in color]

Table 5. Comparison with sampling-based methods in terms of
classiﬁcation accuracy on the CUB-200-2011 dataset.

Table 6. Comparison with part-based methods (all the results are
reported in high-resolution setting) in terms of classiﬁcation accu-
racy on the CUB-200-2011 dataset.

Approach

Resolution Accuracy

Resnet-50 [8]
Resnet-50 [8]
DT-RAM [19]

SSN [22]

TASN (ours)

224
448
224
227
224

81.6
85.6
82.8
84.5
87.0

lutions (a similar drop can also be observed on Resnet-50
with 672 inputs).

Moreover, to study the attention selection strategy (i.e.,
ranking selection vs. random selection), we ranked atten-
tion maps by their response, and sample high response ones
with large possibility, while the recognition performance
dropped from 87.0% to 86.8%. The reason is that ranking
makes some parts rarely picked, while such parts can also
beneﬁt details learning. We also conducted experiments on
distilling two parts in each iteration, and the result is the
same as distilling one part each time.

Compared to sampling-based methods. We compare
our TASN with three sampling-based methods: 1) uni-
formed sampling with high resolution (i.e., zoom in), 2)
uniformed sampling with attention (i.e., crop) and 3) non-
uniformed sampling proposed in SSN [22]. As shown in
Table 5, higher resolution can signiﬁcantly improve ﬁne-
grained recognition performance by 4.9% relatively. How-
ever, 448 input increases the computational cost (i.e., ﬂops)
by four times compared to 224 input. SSN [22] obtains a
better results than DT-RAM [19], and our TASN can fur-
ther obtain 2.9% relative improvement. Such improvements
mainly come from two aspects: 1) a better sampling mech-
anism considering spatial distortion (1.2%), and 2) a better
ﬁne-grained details optimizing strategy (1.7%).

Compared to attention-based part methods.

In Ta-
ble 6, we compare our TASN to attention-based parts meth-
ods. For a fair comparison, 1) high-resolution input is
adopted by all methods and 2) the same backbone numbers
are used. It can be observed that for VGG based method-
s, our TASN outperforms all the baselines even with only
one backbone. Moreover, after ensembling three backbones

Approach

Backbone

Accuracy

MG-CNN [29]
ST-CNN [11]
RA-CNN [7]
MA-CNN [40]
TASN (ours)
TASN (ours)

MAMC [26]
NTSN [37]
TASN (ours)

3×VGG-16

3×Inception-v2

3×VGG-19
3×VGG-19
1×VGG-19
3×VGG-19

1×Resnet-50
3×Resnet-50
1×Resnet-50

81.7
84.1
85.3
85.4
86.1
87.1

86.5
87.3
87.9

(trained with different parameter settings), TASN can im-
prove the performance by 1.9% over the best 3 parts model
MA-CNN [40]. Moreover, our 3 streams result can also
outperform 6 streams MA-CNN (86.5%) with a margin of
0.7%. We do not ensemble more streams as the model en-
semble is beyond this work. For Resnet-50 based method:
compared with the state-of-the-art single-stream MAMC
[26], our TASN achieves a remarkable improvement by
1.6%. Moreover, although NTSN [37] (K = 2) con-
catenates global feature with two part features, our single-
stream TASN still can achieve 0.6% points increases.

Combining with second-order feature learning meth-
ods. In Table 7, we exhibit that our TASN learns a strong
ﬁrst-order representation, which can further improve the
performance of second-order feature methods. Speciﬁcal-
ly, compared to the best second-order methods iSQRT-COV
[18], our TASN 2k ﬁrst-order feature outperforms their 8k
feature with an improvement by 0.7%, which shows the ef-
fectiveness of our TASN. Moreover, we transfer their re-
leased code to our framework and obtain an accuracy of
89.1%, which shows the compatibility of these two method-
s. Note that for a fair comparison, we follow their settings
and predict the label of a test image by averaging prediction
scores of the image and its horizontal ﬂip.

5018

Table 7. Extensive experiments on combining second-order feature
learning methods.

Table 10. Comparison in terms of classiﬁcation accuracy on the
iNaturalist 2017 dataset.

Approach

Dimension Accuracy

Super Class

# Class

Resnet [8]

SSN [22]

TASN

iSQRT-COV [18]
iSQRT-COV [18]

TASN (ours)

TASN + iSQRT-COV

8k
32k
2k
32k

87.3
88.1
87.9
89.1

Table 8. Component analysis in terms of classiﬁcation accuracy on
the Stanford-Car dataset.

Approach

Baseline
master-net

TASN

TASN (ensemble)
TASN (ensemble)

Backbone

Accuracy

1×VGG-19
1×VGG-19
1×VGG-19
2×VGG-19
3×VGG-19

88.6
90.3
92.4
93.1
93.2

Table 9. Comparison in terms of classiﬁcation accuracy on the
Stanford-Car dataset.

Approach

Backbone

Accuracy

FCAN [21]
MDTP [31]
RA-CNN [7]
MA-CNN [40]
TASN (ours)
TASN (ours)

MAMC [26]
NTSN [37]
TASN (ours)

3×VGG-16
3×VGG-16
3×VGG-19
3×VGG-19
1×VGG-19
3×VGG-19

1×Resnet-50
3×Resnet-50
1×Resnet-50

91.3
92.5
92.5
92.6
92.4
93.2

92.8
93.7
93.8

4.3. Evaluation and analysis on Stanford Car

Table 8 shows the result of VGG-19 baseline, our master-
net, a single TASN model, and TASN ensemble results. We
can observe 1.9% relative improvements by structure pre-
served sampling and further improvements of 2.3% by the
full model. Table 9 compares TASN with attention-based
parts methods. Speciﬁcally, TASN with single VGG-19
achieves comparable results with 3 streams part method-
s. And our ensembled 3 streams TASN outperforms the
best 3 streams part learning methods MA-CNN [40]. Com-
pared to their 5 streams result (92.8%), our result is still
better. For Resnet-50 based method, we compare our TAS-
N to the state-of-the-art method MAMC [26], and achieve
1.1% improvements. Moreover, our single-stream TASN
can achieve slightly better performance than NTSN [37],
which concatenates a global feature with two part features.

4.4. Evaluation and analysis on iNaturalist 2017

We also conduct our TASN on the largest ﬁne-grained
dataset, i.e., iNaturalist 2017. We compare to Resnet [8]
baseline and the best sampling method SSN [22]. All the

Plantae
Insecta
Aves

Reptilia

Mammalia

Fungi

Amphibia
Mollusca
Animalia
Arachnida

Actinopterygii

Chromista
Protozoa

Total

2101
1021
964
289
186
121
115
93
77
56
53
9
4

5089

60.3
69.1
59.1
37.4
50.2
62.5
41.8
56.9
64.8
64.8
57.0
57.6
78.1
59.6

63.9
74.7
68.2
43.9
55.3
64.2
50.2
61.5
67.8
73.8
60.3
57.6
79.5
65.2

66.6
77.6
72.0
46.4
57.7
70.3
51.6
64.7
71.0
75.1
65.5
62.5
79.5
68.2

models use Resnet-101 as the backbone with an input reso-
lution of 224. As there are 13 superclasses in this dataset,
we re-implement SSN [22] with their released code to ob-
tain the performance on each superclass. The results are
shown in Table 10, and we can observe that TASN outper-
forms Resnet baseline and SSN on every superclass. It is
notable that compared to Resnet-101, TASN signiﬁcantly
improves the performance, especially on Reptilia (improved
by 24.0%, relatively) and Aves (improved by 21.8%, rela-
tively), which indicates that such superclasses contain more
ﬁne-grained details.

5. Conclusion

In this paper, we proposed a trilinear attention sampling
network for ﬁne-grained image recognition, which can learn
rich feature representations from hundreds of part propos-
als. Instead of ensembling multiple part CNNs, we adopted
knowledge distilling method to integrate ﬁne-grained fea-
tures into a single stream, which is not only efﬁcient but
also effective. Extensive experiments in CUB-Bird, iNat-
uralist 2017 and Stanford-Car demonstrate that TASN is
able to outperform part-ensemble models even with a sin-
gle stream.
In the future, we will further study the pro-
posed TASN in the following directions: 1) attention selec-
tion strategy, i.e., learning to select which details should be
learned and distilled instead of randomly selecting, 2) con-
duct attention-based sampling over convolutional features
instead of only over images, and 3) extend our work to oth-
er vision tasks, e.g., object detection and segmentation.

Acknowledgement: This work was supported by the
National Key R&D Program of China under Grant 2017YF-
B1300201, the National Natural Science Foundation of Chi-
na (NSFC) under Grants 61622211 and 61620106009 as
well as the Fundamental Research Funds for the Central U-
niversities under Grant WK2100100030.

5019

References

[1] Thomas Berg, Jiongxin Liu, Seung Woo Lee, Michelle L
Alexander, David W Jacobs, and Peter N Belhumeur. Bird-
snap: Large-scale ﬁne-grained visual categorization of birds.
In CVPR, pages 2011–2018, 2014. 1

[2] Steve Branson, Grant Van Horn, Serge J. Belongie, and
Pietro Perona. Bird species categorization using pose nor-
malized deep convolutional nets. In BMVC, 2014. 1

[3] Liang-Chieh Chen, George Papandreou, Iasonas Kokkinos,
Kevin Murphy, and Alan L Yuille. Deeplab: Semantic image
segmentation with deep convolutional nets, atrous convolu-
tion, and fully connected crfs. TPAMI, 40(4):834–848, 2018.
3

[4] Tianqi Chen, Mu Li, Yutian Li, Min Lin, Naiyan Wang,
Minjie Wang, Tianjun Xiao, Bing Xu, Chiyuan Zhang, and
Zheng Zhang. Mxnet: A ﬂexible and efﬁcient machine
learning library for heterogeneous distributed systems. arXiv
preprint arXiv:1512.01274, 2015. 6

[5] Yin Cui, Yang Song, Chen Sun, Andrew Howard, and
Serge Belongie. Large scale ﬁne-grained categorization and
domain-speciﬁc transfer learning.
In CVPR, pages 4109–
4118, 2018. 2

[6] Luc Devroye. Sample-based non-uniform random variate

generation. In WSC, pages 260–265. ACM, 1986. 4

[7] Jianlong Fu, Heliang Zheng, and Tao Mei. Look closer to see
better: Recurrent attention convolutional neural network for
ﬁne-grained image recognition. In CVPR, pages 4438–4446,
2017. 1, 2, 6, 7, 8

[8] Kaiming He, Xiangyu Zhang, Shaoqing Ren, and Jian Sun.
In CVPR,

Deep residual learning for image recognition.
pages 770–778, 2016. 1, 3, 5, 6, 7, 8

[9] Byeongho Heo, Minsik Lee, Sangdoo Yun, and Jin Young
Choi. Knowledge distillation with adversarial samples sup-
porting decision boundary. CoRR, abs/1805.05532, 2018. 3
[10] Geoffrey Hinton, Oriol Vinyals, and Jeff Dean. Distilling the

knowledge in a neural network. stat, 1050:9, 2015. 2, 3, 5

[11] Max Jaderberg, Karen Simonyan, Andrew Zisserman, and
koray kavukcuoglu. Spatial transformer networks. In NIPS,
pages 2017–2025, 2015. 2, 6, 7

[12] Jin-Hwa Kim, Jaehyun Jun, and Byoung-Tak Zhang. Bilin-
In NIPS, pages 1571–1581, 2018.

ear attention networks.
2

[13] Jonathan Krause, Michael Stark, Jia Deng, and Li Fei-Fei.
3D object representations for ﬁne-grained categorization. In
ICCV Workshop, 2013. 1, 5

[14] Alex Krizhevsky, Vinod Nair, and Geoffrey Hinton. The
toronto. e-

http://www. cs.

online:

cifar-10 dataset.
du/kriz/cifar. html, 2014. 1

[15] Alex Krizhevsky, Ilya Sutskever, and Geoffrey E. Hinton.
Imagenet classiﬁcation with deep convolutional neural net-
works. In NIPS, pages 1106–1114, 2012. 1

[16] Michael Lam, Behrooz Mahasseni, and Sinisa Todorovic.
Fine-grained recognition as hsnet search for informative im-
age parts. In CVPR, pages 6497–6506. IEEE, 2017. 1

[17] Yann LeCun, L´eon Bottou, Yoshua Bengio, and Patrick
Haffner. Gradient-based learning applied to document recog-

nition. Proceedings of the IEEE, 86(11):2278–2324, 1998.
2

[18] Peihua Li, Jiangtao Xie, Qilong Wang, and Zilin Gao. To-
wards faster training of global covariance pooling network-
s by iterative matrix square root normalization.
In CVPR,
pages 947–955, 2018. 6, 7, 8

[19] Zhichao Li, Yi Yang, Xiao Liu, Feng Zhou, Shilei Wen, and
Wei Xu. Dynamic computational time for visual attention.
In ICCV, pages 1199–1209, 2017. 2, 5, 7

[20] Xinchen Liu, Wu Liu, Huadong Ma, and Huiyuan Fu. Large-
scale vehicle re-identiﬁcation in urban surveillance videos.
In ICME, pages 1–6. IEEE, 2016. 1

[21] Xiao Liu, Tian Xia, Jiang Wang, Yi Yang, Feng Zhou, and
Yuanqing Lin. Fully convolutional attention networks for
ﬁne-grained recognition. arXiv preprint arXiv:1603.06765,
2016. 5, 8

[22] Adria Recasens, Petr Kellnhofer, Simon Stent, Wojciech Ma-
tusik, and Antonio Torralba. Learning to zoom: a saliency-
based sampling layer for neural networks. In ECCV, pages
51–66, 2018. 2, 5, 6, 7, 8

[23] Olga Russakovsky, Jia Deng, Hao Su, Jonathan Krause, San-
jeev Satheesh, Sean Ma, Zhiheng Huang, Andrej Karpathy,
Aditya Khosla, Michael Bernstein, Alexander C. Berg, and
Li Fei-Fei. ImageNet Large Scale Visual Recognition Chal-
lenge. IJCV, 115(3):211–252, 2015. 1, 6

[24] Marcel Simon and Erik Rodner. Neural activation constella-
tions: Unsupervised part model discovery with convolutional
networks. In ICCV, pages 1143–1151, 2015. 3

[25] Karen Simonyan and Andrew Zisserman. Very deep convo-
lutional networks for large-scale image recognition. In ICLR,
pages 1409–1556, 2015. 1

[26] Ming Sun, Yuchen Yuan, Feng Zhou, and Errui Ding. Multi-
attention multi-class constraint for ﬁne-grained image recog-
nition. In ECCV, pages 805–821, 2018. 2, 6, 7, 8

[27] Grant Van Horn, Oisin Mac Aodha, Yang Song, Yin Cui,
Chen Sun, Alex Shepard, Hartwig Adam, Pietro Perona, and
Serge Belongie. The inaturalist species classiﬁcation and de-
tection dataset. 2018. 5

[28] Ashish Vaswani, Noam Shazeer, Niki Parmar, Jakob Uszko-
reit, Llion Jones, Aidan N Gomez, Łukasz Kaiser, and Illia
Polosukhin. Attention is all you need. In NIPS, pages 5998–
6008, 2017. 6

[29] Dequan Wang, Zhiqiang Shen, Jie Shao, Wei Zhang, Xi-
angyang Xue, and Zheng Zhang. Multiple granularity de-
scriptors for ﬁne-grained categorization.
In ICCV, pages
2399–2406, 2015. 6, 7

[30] Xiaolong Wang, Ross Girshick, Abhinav Gupta, and Kaim-
ing He. Non-local neural networks. In CVPR, pages 7794–
7803, 2018. 2

[31] Yaming Wang, Jonghyun Choi, Vlad Morariu, and Larry S
Davis. Mining discriminative triplets of patches for ﬁne-
grained classiﬁcation.
In CVPR, pages 1163–1172, 2016.
5, 8

[32] Xiu-Shen Wei, Jian-Hao Luo, Jianxin Wu, and Zhi-Hua
Zhou. Selective convolutional descriptor aggregation for
ﬁne-grained image retrieval. TIP, 26(6):2868–2881, 2017.
3

5020

[33] Xiu-Shen Wei, Chen-Wei Xie, Jianxin Wu, and Chunhua
Shen. Mask-cnn: Localizing parts and selecting descriptors
for ﬁne-grained bird species categorization. Pattern Recog-
nition, 76:704–714, 2018. 1, 2

[34] P. Welinder, S. Branson, T. Mita, C. Wah, F. Schroff, S. Be-
longie, and P. Perona. Caltech-UCSD Birds 200. Technical
Report CNS-TR-2010-001, California Institute of Technolo-
gy, 2010. 1, 5

[35] Tianjun Xiao, Yichong Xu, Kuiyuan Yang, Jiaxing Zhang,
Yuxin Peng, and Zheng Zhang. The application of two-level
attention models in deep convolutional neural network for
ﬁne-grained image classiﬁcation. In CVPR, pages 842–850,
2015. 2

[36] Linjie Yang, Ping Luo, Chen Change Loy, and Xiaoou Tang.
A large-scale car dataset for ﬁne-grained categorization and
veriﬁcation. In CVPR, pages 3973–3981, 2015. 1

[37] Ze Yang, Tiange Luo, Dong Wang, Zhiqiang Hu, Jun Gao,
and Liwei Wang. Learning to navigate for ﬁne-grained clas-
siﬁcation. In ECCV, pages 420–435, 2018. 6, 7, 8

[38] Junho Yim, Donggyu Joo, Jihoon Bae, and Junmo Kim. A
gift from knowledge distillation: Fast optimization, network
minimization and transfer learning. In CVPR, pages 4133–
4141, 2017. 3

[39] Xiaopeng Zhang, Hongkai Xiong, Wengang Zhou, Weiyao
Lin, and Qi Tian. Picking deep ﬁlter responses for ﬁne-
grained image recognition.
In CVPR, pages 1134–1142,
2016. 3

[40] Heliang Zheng, Jianlong Fu, Tao Mei, and Jiebo Luo. Learn-
ing multi-attention convolutional neural network for ﬁne-
grained image recognition.
In ICCV, pages 5209–5217,
2017. 1, 2, 3, 6, 7, 8

5021

