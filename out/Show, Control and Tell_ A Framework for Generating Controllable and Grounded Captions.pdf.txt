A Framework for Generating Controllable and Grounded Captions

Show, Control and Tell:

Marcella Cornia Lorenzo Baraldi Rita Cucchiara

University of Modena and Reggio Emilia

{name.surname}@unimore.it

Abstract

Current captioning approaches can describe images us-
ing black-box architectures whose behavior is hardly con-
trollable and explainable from the exterior. As an image can
be described in inﬁnite ways depending on the goal and the
context at hand, a higher degree of controllability is needed
to apply captioning algorithms in complex scenarios.
In
this paper, we introduce a novel framework for image cap-
tioning which can generate diverse descriptions by allow-
ing both grounding and controllability. Given a control sig-
nal in the form of a sequence or set of image regions, we
generate the corresponding caption through a recurrent ar-
chitecture which predicts textual chunks explicitly grounded
on regions, following the constraints of the given control.
Experiments are conducted on Flickr30k Entities and on
COCO Entities, an extended version of COCO in which we
add grounding annotations collected in a semi-automatic
manner. Results demonstrate that our method achieves state
of the art performances on controllable image captioning,
in terms of caption quality and diversity. Code and an-
notations are publicly available at: https://github.
com/aimagelab/show-control-and-tell.

1. Introduction

Image captioning brings vision and language together
in a generative way. As a fundamental step towards ma-
chine intelligence, this task has been recently gaining much
attention thanks to the spread of Deep Learning architec-
tures which can effectively describe images in natural lan-
guage [42, 18, 46, 43]. Image captioning approaches are
usually capable of learning a correspondence between an
input image and a probability distribution over time, from
which captions can be sampled either using a greedy de-
coding strategy [43], or more sophisticated techniques like
beam search and its variants [1].

As the two main components of captioning architectures
are the image encoding stage and the language model, re-

Figure 1: Comparison between (a) captioning models with
global visual feature [43], (b) attentive models which in-
tegrate features from image regions [3] and (c) our Show,
Control and Tell. Our method can produce multiple cap-
tions for a given image, depending on a control signal
which can be either a sequence or a set of image regions.
Moreover, chunks of the generated sentences are explicitly
grounded on regions.

searchers have focused on improving both phases, which
resulted in the emergence of attentive models [46] on one
side, and of more sophisticated interactions with the lan-
guage model on the other [25, 5]. Recently, attentive models
have been improved by replacing the attention over a grid
of features with attention over image regions [3, 44, 50]. In
these models, the generative process attends a set of regions
which are softly selected while generating the caption.

Despite these advancements, captioning models still lack
controllability and explainability – i.e., their behavior can
hardly be inﬂuenced and explained. As an example, in the
case of attention-driven models, the architecture implicitly
selects which regions to focus on at each timestep, but it
cannot be supervised from the exterior. While an image
can be described in multiple ways, such an architecture pro-
vides no way of controlling which regions are described and
what importance is given to each region. This lack of con-
trollability creates a distance between human and machine

8307

c)A girl isflyinga kitein a field.b)…a)Up-Down CaptioningModelStandard CaptioningModelA girl isflyinga kitein a field.A girl standing on a hillflyingkites.A girl isflyinga kitewith a group of people.DetectionSetDetectionSequenceControllableCaptioningModelControllableCaptioningModelintelligence, as humans can manage the variety of ways in
which an image can be described, and select the most appro-
priate one depending on the task and the context at hand.
Most importantly, this also limits the applicability of cap-
tioning algorithms to complex scenarios in which some con-
trol over the generation process is needed. As an example,
a captioning-based driver assistance system would need to
focus on dangerous objects on the road to alert the driver,
rather than describing the presence of trees and cars when a
risky situation is detected. Eventually, such systems would
also need to be explainable, so that their behavior could be
easily interpreted in case of failures.

In this paper, we introduce Show, Control and Tell, that
explicitly addresses these shortcomings (Fig. 1). It can gen-
erate diverse natural language captions depending on a con-
trol signal which can be given either as a sequence or as a set
of image regions which need to be described. As such, our
method is capable of describing the same image by focus-
ing on different regions and in a different order, following
the given conditioning. Our model is built on a recurrent ar-
chitecture which considers the decomposition of a sentence
into noun chunks and models the relationship between im-
age regions and textual chunks, so that the generation pro-
cess can be explicitly grounded on image regions. To the
best of our knowledge, this is the ﬁrst captioning framework
controllable from image regions.

Contributions. Our contributions are as follows:

• We propose a novel framework for image captioning
which is controllable from the exterior, and which can
produce natural language captions explicitly grounded
on a sequence or a set of image regions.

• The model explicitly considers the hierarchical struc-
ture of a sentence by predicting a sequence of noun
chunks. Also, it takes into account the distinction be-
tween visual and textual words, thus providing an ad-
ditional grounding at the word level.

• We evaluate the model with respect to a set of care-
fully designed baselines, on Flickr30k Entities and on
COCO, which we semi-automatically augment with
grounding image regions for training and evaluation
purposes.

• Our proposed method achieves state of the art re-
sults for controllable image captioning on Flick30k
and COCO both in terms of diversity and caption qual-
ity, even when compared with methods which focus on
diversity.

2. Related work

A large number of models has been proposed for im-
age captioning [37, 47, 24, 23, 17, 25]. Generally, all in-
tegrate recurrent neural networks as language models, and
a representation of the image which might be given by the
output of one or more layer of a CNN [43, 10, 37, 24], or

by a time-varying vector extracted with an attention mech-
anism [46, 48, 24, 7, 3] selected either from a grid over
CNN features, or integrating image regions eventually ex-
tracted from a detector [32, 3]. Attentive models provided
a ﬁrst way of grounding words to parts of the image, al-
though with a blurry indication which was rarely semanti-
cally signiﬁcant. Regarding the training strategies, notable
advances have been made by using Reinforcement Learning
to train non-differentiable captioning metrics [35, 23, 37].
In this work, we propose an extended version of this ap-
proach which deals with multiple output distributions and
rewards the alignment of the caption to the control signal.

Recently, more principled approaches have been pro-
posed for grounding a caption on the image [34, 38, 15, 16]:
DenseCap [17] generates descriptions for speciﬁc image re-
gions. Further, the Neural Baby Talk approach [25] extends
the attentive model in a two-step design in which a word-
level sentence template is ﬁrstly generated and then ﬁlled
by object detectors with concepts found in the image. We
instead decompose the caption at the level of noun chunks,
and explicitly ground each of them to a region. This ap-
proach has the additional beneﬁt of providing an explicabil-
ity method at the chunk level.

Another related line of work is that of generating diverse
descriptions. Some works have extended the beam-search
algorithm to sample multiple captions from the same distri-
bution [41, 1], while different GAN-based approaches have
also appeared [8, 39, 45]. Most of these improve on diver-
sity, but suffer on accuracy and do not provide controlla-
bility over the generation process. Others have conditioned
the generation with a speciﬁc style or sentiment [27, 28, 11].
Our work is mostly related to [9], which uses a control in-
put as a sequence of part-of-speech tags. This approach,
while generating diversity, is hardly employable to effec-
tively control the generation of the sentence; in contrast, we
use image regions as a controllability method.

3. Method

Sentences are natural language structures which are hi-
erarchical by nature [26]. At the lowest level, a sentence
might be thought as a sequence of words:
in the case of
a sentence describing an image, we can further distinguish
between visual words, which describe something visually
present in the image, and textual words, that refer to entities
which are not present in the image [25]. Analyzing further
the syntactic dependencies between words, we can recover
a higher abstraction level in which words can be organized
into a tree-like structure: in a dependency tree [12, 14, 6],
each word is linked together with its modiﬁers (Fig. 2).

Given a dependency tree, nouns can be grouped with
their modiﬁers, thus building noun chunks. For instance,
the caption depicted in Fig. 2 can be decomposed into a se-
quence of different noun chunks: “a young boy”, “a cap”,

8308

det

pobj

pobj

amod

prep

det

prep

poss

A young boy with a cap on his head,

striped shirt, and gray sweat

jacket.

amod

cc

compound

amod

Figure 2: Example of a dependency tree for a caption. Noun
chunks are marked with rounded boxes; chunks correspond-
ing to image regions are depicted using the same color.

“his head”, “striped shirt”, and “gray and sweat jacket”. As
noun chunks, just like words, can be visually grounded into
image regions, a caption can also be mapped to a sequence
of regions, each corresponding to a noun chunk. A chunk
might also be associated with multiple image regions of the
same class if more than one possible mapping exists.

The number of ways in which an image can be described
results in different sequences of chunks, linked together to
form a ﬂuent sentence. Therefore, captions also differ in
terms of the set of considered regions, the order in which
they are described, and their mapping to chunks given by
the linguistic abilities of the annotator.

Following these premises, we deﬁne a model which can
recover the variety of ways in which an image can be de-
scribed, given a control input expressed as a sequence or set
of image regions. We begin by presenting the former case,
and then show how our model deals with the latter scenario.

3.1. Generating controllable captions

Given an image I and an ordered sequence of set of
regions R = (r0, r1, ..., rN )1, the goal of our captioning
model is to generate a sentence y = (y0, y1, ..., yT ) which
in turns describes all the regions in R while maintaining the
ﬂuency of language.

Our model is conditioned on both the input image I
and the sequence of region sets R, which acts as a control
signal, and jointly predicts two output distributions which
correspond to the word-level and chunk-level representa-
tion of the sentence: the probability of generating a word
at a given time, i.e. p(yt|R, I; θ), and that of switching
from one chunk to another, i.e. p(gt|R, I; θ), where gt is
a boolean chunk-shifting gate. During the generation, the
model maintains a pointer to the current region set ri and
can shift to the next element in R by means of the gate gt.
To generate the output caption, we employ a recurrent
neural network with adaptive attention. At each timestep,
we compute the hidden state ht according to the previous
hidden state ht−1, the current image region set rt and the

1For generality, we will always consider sequences of sets of regions, to
deal with the case in which a chunk in the target sentence can be associated
to multiple regions in training and evaluation data.

current word wt, such that ht = RNN(wt, rt, ht−1). At
training time, rt and wt are the ground-truth region set and
word corresponding to timestep t; at test time, wt is sampled
from the ﬁrst distribution predicted by the model, while the
choice of the next image region is driven by the values of the
chunk-shifting gate sampled from the second distribution:

rt+1 ← R[i], where i = min  t
Xk=1

gk, N! , gk ∈ {0, 1}

(1)
where {gk}k is the sequence of sampled gate values, and N
is the number of region sets in R.
Chunk-shifting gate. We compute p(gt|R) via an adaptive
mechanism in which the LSTM computes a compatibility
function between its internal state and a latent representa-
tion which models the state of the memory at the end of a
chunk. The compatibility score is compared to that of at-
tending one of the regions in rt, and the result is used as an
indicator to switch to the next region set in R.

The LSTM is ﬁrstly extended to obtain a chunk sentinel
sc
t , which models a component extracted from the memory
encoding the state of the LSTM at the end of a chunk. The
sentinel is computed as:

lc
t = σ(Wigxt + Whght−1)
sc
t = lc

t ⊙ tanh(mt)

(2)

(3)

where Wig ∈ Rd×k, Whg ∈ Rd×d are learnable weights,
mt ∈ Rd is the LSTM cell memory and xt ∈ Rk is the
input of the LSTM at time t; ⊙ represents the Hadamard
element-wise product and σ the sigmoid logistic function.

We then compute a compatibility score between the in-
ternal state ht and the sentinel vector through a single-layer
neural network; analogously, we compute a compatibility
function between ht and the regions in rt.

zc
t = wT

h tanh(Wsgsc

t + Wght)

(4)

zr
t = wT

h tanh(Wsrrt + (Wght)✶T )

(5)
where n is the number of regions in rt, ✶ ∈ Rn is a vector
with all elements set to 1, wT
h is a row vector, and all W∗,
w∗ are learnable parameters. Notice that the representation
extracted from the internal state is shared between all com-
patibility scores, as if the region set and the sentinel vector
were part of the same attentive distribution. Contrarily to an
attentive mechanism, however, there is no value extraction.
The probability of shifting from one chunk to the next
one is deﬁned as the probability of attending the sentinel
vector sc

t in a distribution over sc

t and the regions in rt:

p(gt = 1|R) =

exp zc

i=1 exp zr

ti

(6)

where zr
t , and we dropped
the dependency between n and t for clarity. At test time, the

ti indicates the i-th element in zr

exp zc
t

t +Pn

8309

Figure 3: Overview of the approach. Given an image and a control signal, the ﬁgure shows the process to generate the
controlled caption and the architecture of the language model.

value of gate gt ∈ {0, 1} is then sampled from p(gt|R) and
drives the shifting to the next region set in R.

Adaptive attention with visual sentinel. While the chunk-
shifting gate predicts the end of a chunk, thus linking the
generation process with the control signal given by R, once
rt has been selected a second mechanism is needed to at-
tend its regions and distinguish between visual and textual
words. To this end, we build an adaptive attention mecha-
nism with a visual sentinel [24].

The visual sentinel vector models a component of the
memory to which the model can fall back when it chooses
to not attend a region in rt. Analogously to Eq. 2, it is
deﬁned as:

lv
t = σ(Wisxt + Whsht−1)
sv
t = lv

t ⊙ tanh(mt)

(7)

(8)

where Wis ∈ Rd×k and Whs ∈ Rd×d are matrices of
learnable weights. An attentive distribution is then gener-
ated over the regions in rt and the visual sentinel vector sv
t :

αt = softmax([zr

t ; wT

h tanh(Wsssv

t + Wght)])

(9)

where [·] indicates concatenation. Based on the attention
distribution, we obtain a context vector which can be fed to
the LSTM as a representation of what the network is attend-
ing:

ct =

αti[rt; sv
t ]

(10)

n+1

Xi=1

Notice that the context vector will be, mostly, an approx-
imation of one of the regions in rt or the visual sentinel.
However, rt will vary at different timestep according to the
chunk-shifting mechanism, thus following the control input.
The model can alternate the generation of visual and textual
words by means of the visual sentinel.

3.2. Objective

The captioning model is trained using a loss function
which considers the two output distributions of the model.
Given the target ground-truth caption y∗
1:T , the ground-truth
region sets r∗
1:T and chunk-shifting gate values correspond-
ing to each timestep g∗
1:T , we train both distributions by
means of a cross-entropy loss. The relationship between
target region sets and gate values will be further expanded
in the implementation details. The loss function for a sam-
ple is deﬁned as:

Word-level probability

L(θ) = −

p(y∗

t |r∗

1:t, y∗

1:t−1) +

T

Xt=1(cid:16) log

z

}|

+ g∗

t log p(gt = 1|r∗

1:t, y∗

1:t−1)+
t )(1 − log p(gt = 1|r∗

+ (1 − g∗

1:t, y∗

1:t−1)

Chunk-level probability

|

(cid:17) (11)

}

{

{z

Following previous works [35, 37, 3], after a pre-training
step using cross-entropy, we further optimize the sequence
generation using Reinforcement Learning. Speciﬁcally, we
use the self-critical sequence training approach [37], which
baselines the REINFORCE algorithm with the reward ob-
tained under the inference model at test time.

Given the nature of our model, we extend the approach to
work on multiple output distributions. At each timestep, we
sample from both p(yt|R) and p(gt|R) to obtain the next
word wt+1 and region set rt+1. Once a EOS tag is reached,
we compute the reward of the sampled sentence ws and
backpropagate with respect to both the sampled word se-
quence ws and the sequence of chunk-shifting gates gs.
The ﬁnal gradient expression is thus:

∇θL(θ) = −(r(ws) − b)(∇θ log p(ws) + ∇θ log p(gs))
(12)

8310

DetectionSetSortingNetworkDetectionSequencedoganexttoChunk-Shifting GateAdaptive AttentionLanguage LSTMAttentionLSTMLanguage Model123aonbikeasidewalkControl SignalInput Imagesittingwhere b = r( ˆw) is the reward of the sentence obtained us-
ing the inference procedure (i.e. by sampling the word and
gate value with maximum probability). We then build a
reward function which jointly considers the quality of the
caption and its alignment with the control signal R.
Rewarding caption quality. To reward the overall quality
of the generated caption, we use image captioning metrics
as a reward. Following previous works [3], we employ the
CIDEr metric (speciﬁcally, the CIDEr-D score) which has
been shown to correlate better with human judgment [40].
Rewarding the alignment. While captioning metrics can
reward the semantic quality of the sentence, none of them
can evaluate the alignment with respect to the control in-
put2. Therefore, we introduce an alignment score based on
the Needleman-Wunsch algorithm [30].

Given a predicted caption y and its target counterpart
y∗, we extract all nouns from both sentences, and evaluate
the alignment between them, recalling the relationships be-
tween noun chunks and region sets. We use the following
scoring system: the reward for matching two nouns is equal
to the cosine similarity between their word embeddings; a
gap gets a negative reward equal to the minimum similarity
value, i.e. −1. Once the optimal alignment is computed, we
normalize its score, al(y, y∗) with respect to the length of
the sequences. The alignment score is thus deﬁned as:

NW(y, y∗) =

al(y, y∗)

max(#y, #y∗)

(13)

where #y and #y∗ represent the number of nouns con-
tained in y and y∗, respectively. Notice that NW(·, ·) ∈
[−1, 1]. The ﬁnal reward that we employ is a weighted ver-
sion of CIDEr-D and the alignment score.

3.3. Controllability through a set of detections

The proposed architecture, so far, can generate a caption
controlled by a sequence of region sets R. To deal with
the case in which the control signal is unsorted, i.e. a set of
regions sets, we build a sorting network which can arrange
the control signal in a candidate order, learning from data.
The resulting sequence can then be given to the captioning
network to produce the output caption (Fig. 3).

To this aim, we train a network which can learn a per-
mutation, taking inspiration from Sinkhorn networks [29].
As shown in [29], the non-differentiable parameterization
of a permutation can be approximated in terms of a differ-
entiable relaxation, the so-called Sinkhorn operator. While
a permutation matrix has exactly one entry of 1 in each row
and each column, the Sinkhorn operator iteratively normal-
izes rows and columns of any matrix to obtain a “soft” per-

2Although METEOR creates an alignment with respect to the reference
caption, this is done for each unigram, thus mixing semantic and alignment
errors.

mutation matrix, i.e. a real-valued matrix close to a permu-
tation one.

Given a set of region sets R = {r1, r2, ..., rN }, we learn
a mapping from R to its sorted version R∗. Firstly, we
pass each element in R through a fully-connected network
which processes every item of a region set independently
and produces a single output feature vector with length N .
By concatenating together the feature vectors obtained for
all region sets, we thus get a N × N matrix, which is then
passed to the Sinkhorn operator to obtain the soft permuta-
tion matrix P . The network is then trained by minimizing
the mean square error between the scrambled input and its
reconstructed version obtained by applying the soft permu-
tation matrix to the sorted ground-truth, i.e. P T R∗.

At test time, we take the soft permutation matrix and ap-
ply the Hungarian algorithm [20] to obtain the ﬁnal permu-
tation matrix, which is then used to get the sorted version of
R for the captioning network.

3.4. Implementation details

Language model and image features. We use a language
model with two LSTM layers (Fig. 3): the input of the bot-
tom layer is the concatenation of the embedding of the cur-
rent word, the image descriptor, as well as the hidden state
of the second layer. This layer predicts the context vector
via the visual sentinel as well as the chunk-gate. The sec-
ond layer, instead, takes as input the context vector and the
hidden state of the bottom layer and predicts the next word.
To represent image regions, we use Faster R-CNN [36]
with ResNet-101 [13]. In particular, we employ the model
ﬁnetuned on the Visual Genome dataset [19] provided
by [3]. As image descriptor, following the same work [3],
we average the feature vectors of all the detections.

The hidden size of the LSTM layers is set to 1000, and
that of attention layers to 512, while the input word embed-
ding size is set to 1000.
Ground-truth chunk-shifting gate sequences. Given a
sentence where each word of a noun chunk is associated to a
region set, we build the chunk-shifting gate sequence {g∗
t }t
by setting g∗
t to 1 on the last word of every noun chunk, and
0 otherwise. The region set sequence {r∗
t }t is built accord-
ingly, by replicating the same region set until the end of a
noun chunk, and then using the region set of the next chunk.
To compute the alignment score and for extracting depen-
dencies, we use the spaCy NLP toolkit3. We use GloVe [33]
as word vectors.
Sorting network. To represent regions, we use Faster R-
CNN vectors, the normalized position and size and the
GloVe embedding of the region class. Additional details
on architectures and training can be found in the Supple-
mentary material.

3https://spacy.io/

8311

Figure 4: Sample captions and corresponding visual groundings from the COCO Entities dataset. Different colors show a correspondence
between visual chunks and image regions.

COCO Entities (ours)

Train Validation Test

Nb. of captions
Nb. of noun chunks
Nb. of noun chunks per caption
Nb. of unique classes

545,202
1,518,667

7,818
20,787

7,797
20,596

2.79
1,330

2.66
725

2.64
730

Flickr30k Entities

Train Validation Test

Nb. of captions
Nb. of noun chunks
Nb. of noun chunks per caption
Nb. of unique classes

144,256
416,018

2.88
1,026

5,053
14,626

4,982
14,556

2.89
465

2.92
458

Table 1: Statistics on our COCO Entities dataset, in com-
parison with those of Flick30k Entities.

4. Experiments

4.1. Datasets

We experiment with two datasets: Flickr30k Entities,
which already contains the associations between chunks
and image regions, and COCO, which we annotate semi-
automatically. Table 1 summarizes the datasets we use.
Flickr30k Entities [34]. Based on Flickr30k [49], it con-
tains 31, 000 images annotated with ﬁve sentences each.
Entity mentions in the caption are linked with one or
more corresponding bounding boxes in the image. Overall,
276, 000 manually annotated bounding boxes are available.
In our experiments, we automatically associate each bound-
ing box with the image region with maximum IoU among
those detected by the object detector. We use the splits pro-
vided by Karpathy et al. [18].
COCO Entities. Microsoft COCO [22] contains more than
120, 000 images, each of them annotated with around ﬁve
crowd-sourced captions. Here, we again follow the splits
deﬁned by [18] and automatically associate noun chunks
with image regions extracted from the detector [36].

We ﬁrstly build an index associating each noun of the
dataset with the ﬁve most similar class names, using word
vectors. Then, each noun chunk in a caption is associated
by using either its name or the base form of its name, with
the ﬁrst class found in the index which is available in the im-
age. This association process, as conﬁrmed by an extensive

manual veriﬁcation step, is generally reliable and produces
few false positive associations. Naturally, it can result in re-
gion sets with more than one element (as in Flickr30k), and
noun chunks with an empty region set. In this case, we ﬁll
empty training region sets with the most probable detections
of the image and let the adaptive attention mechanism learn
the corresponding association; in validation and testing, we
drop those captions. Some examples of the additional an-
notations extracted from COCO are shown in Fig. 4.

4.2. Experimental setting

The experimental settings we employ is different from
that of standard image captioning. In our scenario, indeed,
the sequence of set of regions is a second input to the model
which shall be consider when selecting the ground-truth
sentences to compare against. Also, we employ additional
metrics beyond the standard ones like BLEU-4 [31], ME-
TEOR [4], ROUGE [21], CIDEr [40] and SPICE [2].

When evaluating the controllability with respect to a se-
quence, for each ground-truth regions-image input (R, I),
we evaluate against all captions in the dataset which share
the same pair. Also, we employ the alignment score (NW)
to evaluate how the model follows the control input.

Similarly, when evaluating the controllability with re-
spect to a set of regions, given a set-image pair (R, I), we
evaluate against all ground-truth captions which have the
same input. To assess how the predicted caption covers
the control signal, we also deﬁne a soft intersection-over-
union (IoU) measure between the ground-truth set of nouns
and its predicted counterpart, recalling the relationships be-
tween region sets and noun chunks. Firstly, we compute
the optimal assignment between the two set of nouns, us-
ing distances between word vectors and the Hungarian al-
gorithm [20], and deﬁne an intersection score between the
two sets as the sum of assignment proﬁts. Then, recalling
that set union can be expressed in function of an intersec-
tion, we deﬁne the IoU measure as follows:

IoU(y, y∗) =

I(y, y∗)

#y + #y∗ − I(y, y∗)

(14)

where I(·, ·) is the intersection score, and the # operator
represents the cardinality of the two sets of nouns.

8312

A younggirl issitting down with herdog.A woman sitting ata tablewith a dog eatingcake.A woman and a dog that is eating from a plate.A young man walking past a red fire hydrant.A man walks past a red fire hydranton the sidewalk.A man in a white t-shirt walking past a fire hydrant.Cross-Entropy Loss

CIDEr Optimization

CIDEr + NW Optimization

Method

B-4 M R

C

S NW B-4 M R

C

S NW B-4 M R

C

S NW

FC-2K† [37]
10.4 17.3 36.8 98.3 25.2 0.257
Up-Down† [3]
12.9 19.3 40.0 119.9 29.3 0.296
Neural Baby Talk† [25] 12.9 19.2 40.4 120.2 29.5 0.305

12.3 18.5 39.6 117.5 26.9 0.273
14.2 20.0 42.1 133.9 30.0 0.310

-

-

-

-

-

-

-
-
-

-
-
-

-
-
-

-
-
-

-
-
-

-
-
-

Controllable LSTM
11.4 18.1 38.5 106.8 27.6 0.275
Controllable Up-Down 17.3 23.0 46.7 161.0 39.1 0.396

12.8 18.9 40.9 123.0 28.5 0.290
17.4 22.9 47.1 168.5 39.0 0.397

12.9 19.3 41.3 124.0 28.9 0.341
17.9 23.6 48.2 171.3 40.7 0.443

Ours w/ single sentinel 20.0 23.9 51.1 183.3 43.9 0.480
Ours w/o visual sentinel 20.8 24.4 52.4 191.2 45.1 0.508
20.9 24.4 52.5 193.0 45.3 0.508
Ours

21.7 25.3 54.5 202.6 47.6 0.606
22.2 25.4 55.0 206.2 47.6 0.607
22.5 25.6 55.1 210.1 48.1 0.615

21.3 25.3 54.5 201.1 48.1 0.648
21.5 25.1 54.7 202.2 48.1 0.639
22.3 25.6 55.3 209.7 48.5 0.649

Table 2: Controllability via a sequence of regions, on test portion of COCO Entities. NW refers to the visual chunk alignment
measure deﬁned in Sec. 3.2. The † marker indicates non-controllable methods.

Figure 5: Sample results of controllability via a sequence of regions. Different colors and numbers show the control sequence
and the associations between chunks and regions.

Method

B-4 M R

C

S NW

Neural Baby Talk† [25] 8.5 13.5 31.7 53.9 17.9 0.090

Controllable LSTM
6.5 12.6 30.2 43.5 15.8 0.124
Controllable Up-Down 10.4 15.2 35.2 69.5 21.7 0.190

Ours w/ single sentinel 10.7 16.1 38.1 76.5 22.8 0.260
Ours w/o visual sentinel 11.1 15.5 37.2 74.7 22.4 0.244
12.5 16.8 38.9 84.0 23.5 0.263
Ours

this baseline we ablate our model by removing the visual
sentinel. The resulting baseline, therefore, lacks a mecha-
nism to distinguish between visual and textual words.
Ours with single sentinel. Again, we ablate our model by
merging the visual and chunk sentinel: a single sentinel is
used for both roles, in place of sc
As further baselines, we also compare against non-
controllable captioning approaches, like FC-2K [37], Up-
Down [3], and Neural Baby Talk [25].

t and sv
t .

Table 3: Controllability via a sequence of regions, on the
test portion of Flickr30K Entities.

4.4. Quantitative results

4.3. Baselines

Controllable LSTM. We start from a model without atten-
tion: an LSTM language model with a single visual fea-
ture vector. Then, we generate a sequential control input
by feeding a ﬂattened version of R to a second LSTM and
taking the last hidden state, which is concatenated to the
visual feature vector. The structure of the language model
resembles that of [3], without attention.
Controllable Up-Down. In this case, we employ the full
Up-Down model from [3], which creates an attentive distri-
bution over image regions and make it controllable by feed-
ing only the regions selected in R and ignoring the rest.
This baseline is not sequentially controllable.
Ours without visual sentinel. To investigate the role of the
visual sentinel and its interaction with the gate sentinel, in

Controllability through a sequence of detections. Firstly,
we show the performance of our model when providing the
full control signal as a sequence of region sets. Table 2
shows results on COCO Entities, in comparison with the
aforementioned approaches. We can see that our method
achieves state of the art results on all automatic evaluation
metrics, outperforming all baselines both in terms of over-
all caption quality and in terms of alignment with the con-
trol signal. Using the cross-entropy pre-training, we out-
perform the Controllable LSTM and Controllable Up-Down
by 32.0 on CIDEr and 0.112 on NW. Optimizing the model
with CIDEr and NW further increases the alignment qual-
ity while maintaining outperforming results on all metrics,
leading to a ﬁnal 0.649 on NW, which outperforms the Con-
trollable Up-Down baseline by a 0.25. Recalling that NW
ranges from −1 to 1, this improvement amounts to a 12.5%
of the full metric range.

8313

Agraffitionawallwithawomanonthesidewalk.Awomanwalkingdownasidewalkinfrontofagraffiti.1234312Adogsittingonabenchwithaman.213Acoupleofpeoplesittingonabenchwithadog.231Acoupleofhorsesstandingontopofafield.Twohorsesgrazinginafieldofgrasswithtreesandafence.1212345Figure 6: Sample results of controllability via a set of regions. Different colors show the control set and the associations
between chunks and regions.

Method

B-4 M R

C

S

IoU

Method

B-4 M R

C

S

IoU

FC-2K† [37]
12.5 18.5 39.6 116.5 26.6 61.0
Up-Down† [3]
14.4 20.0 42.2 132.8 29.7 63.2
Neural Baby Talk† [25] 13.1 19.2 40.5 119.1 29.2 62.6

Controllable LSTM
12.9 19.3 41.3 123.4 28.7 64.2
Controllable Up-Down 18.1 23.6 48.4 170.5 40.4 71.6

Ours w/ single sentinel 17.4 23.6 48.4 168.4 43.7 75.4
Ours w/o visual sentinel 17.6 23.4 48.5 168.9 43.6 75.3
18.0 23.8 48.9 173.3 44.1 75.5
Ours

Table 4: Controllability via a set of regions, on the test por-
tion of COCO Entities.

In Table 3, we instead show the results of the same exper-
iments on Flickr30k Entities, using CIDEr+NW optimiza-
tion for all controllable methods. Also on this manually an-
notated dataset, our method outperforms all the compared
approaches by a signiﬁcant margin, both in terms of cap-
tion quality and alignment with the control signal.

Controllability through a set of detections. We then as-
sess the performance of our model when controlled with
a set of detections. Tables 4 and 5 show the performance
of our method in this setting, respectively on COCO Enti-
ties and Flickr30k Entities. We notice that the proposed ap-
proach outperforms all baselines and compared approaches
in terms of IoU, thus testifying that we are capable of re-
specting the control signal more effectively. This is also
combined with better captioning metrics, which indicate
higher semantic quality.

Diversity evaluation. Finally, we also assess the diver-
sity of the generated captions, comparing with the most re-
cent approaches that focus on diversity. In particular, the
variational autoencoder proposed in [45] and the approach
of [9], which allows diversity and controllability by feeding
PoS sequences. To test our method on a signiﬁcant num-
ber of diverse captions, given an image we take all regions
which are found in control region sets, and take the permu-
tations which result in captions with higher log-probability.
This approach is fairly similar to the sampling strategy used
in [9], even if ours considers region sets. Then, we follow
the experimental approach deﬁned in [45, 9]: each ground-

Neural Baby Talk† [25] 8.6 13.5 31.9 53.8 17.8 49.9

Controllable LSTM
6.4 12.5 30.2 42.9 15.6 50.8
Controllable Up-Down 10.5 15.2 35.5 69.5 21.6 54.8

9.5 15.2 35.8 65.6 21.2 55.0
Ours w/ single sentinel
Ours w/o visual sentinel 9.8 14.8 35.0 64.2 20.9 54.3
10.9 15.8 36.2 70.4 21.8 55.0
Ours

Table 5: Controllability via a set of regions, on the test por-
tion of Flickr30K Entities.

Method

Samples B-4 M R

C

S

AG-CVAE [45]
POS [9]

Ours

20
20

20

47.1 30.9 63.8 130.8 24.4
44.9 36.5 67.8 146.8 27.7

44.8 36.6 68.9 156.5 30.9

Table 6: Diversity performance on the test portion of
COCO.

truth sentence is evaluated against the generated caption
with the maximum score for each metric. Higher scores,
thus, indicate that the method is capable of sampling high
accuracy captions. Results are reported in Table 6, where to
guarantee the fairness of the comparison, we run this exper-
iments on the full COCO test split. As it can be seen, our
method can generate signiﬁcantly diverse captions.

5. Conclusion

We presented Show, Control and Tell, a framework for
generating controllable and grounded captions through re-
gions. Our work is motivated by the need of bringing
captioning systems to more complex scenarios. The ap-
proach considers the decomposition of a sentence into
noun chunks, and grounds chunks to image regions follow-
ing a control signal. Experimental results, conducted on
Flickr30k and on COCO Entities, validate the effectiveness
of our approach in terms of controllability and diversity.

8314

Aboyhittingatennisballonacourt.Aboyinaredshirtholdingatennisracketonacourt.Agirlwearingsunglassesholdingafrisbeeonthegrass.Agirlstandinginthegrassholdingafrisbee.Amanandawomantotingaluggageonastreetwithadoor.Awomanwithaluggagenexttoaredfirehydrantonasidewalk.References

[1] Peter Anderson, Basura Fernando, Mark Johnson, and
Stephen Gould. Guided open vocabulary image captioning
with constrained beam search. In Proceedings of the Confer-
ence on Empirical Methods in Natural Language Processing,
2016.

[2] Peter Anderson, Basura Fernando, Mark Johnson, and
Stephen Gould. SPICE: Semantic Propositional Image Cap-
tion Evaluation. In Proceedings of the European Conference
on Computer Vision, 2016.

[3] Peter Anderson, Xiaodong He, Chris Buehler, Damien
Teney, Mark Johnson, Stephen Gould, and Lei Zhang.
Bottom-up and top-down attention for image captioning and
visual question answering. In Proceedings of the IEEE Con-
ference on Computer Vision and Pattern Recognition, 2018.

[4] Satanjeev Banerjee and Alon Lavie. Meteor: An automatic
metric for mt evaluation with improved correlation with hu-
man judgments.
In Proceedings of the ACL Workshop on
Intrinsic and Extrinsic Evaluation Measures for Machine
Translation and/or Summarization, 2005.

[5] Lorenzo Baraldi, Costantino Grana, and Rita Cucchiara. Hi-
erarchical boundary-aware neural encoder for video caption-
ing. In Proceedings of the IEEE Conference on Computer
Vision and Pattern Recognition, 2017.

[6] Danqi Chen and Christopher Manning. A fast and accurate
dependency parser using neural networks. In Proceedings of
the Conference on Empirical Methods in Natural Language
Processing, 2014.

[7] Marcella Cornia, Lorenzo Baraldi, Giuseppe Serra, and Rita
Cucchiara. Paying more attention to saliency: Image cap-
tioning with saliency and context attention. ACM Transac-
tions on Multimedia Computing, Communications, and Ap-
plications, 14(2):48, 2018.

[8] Bo Dai, Sanja Fidler, Raquel Urtasun, and Dahua Lin. To-
wards Diverse and Natural Image Descriptions via a Condi-
tional GAN. In Proceedings of the International Conference
on Computer Vision, 2017.

[9] Aditya Deshpande, Jyoti Aneja, Liwei Wang, Alexander
Schwing, and David A Forsyth. Diverse and controllable im-
age captioning with part-of-speech guidance. arXiv preprint
arXiv:1805.12589, 2018.

[10] Jeffrey Donahue, Lisa Anne Hendricks, Sergio Guadarrama,
Marcus Rohrbach, Subhashini Venugopalan, Kate Saenko,
and Trevor Darrell. Long-term recurrent convolutional net-
works for visual recognition and description.
In Proceed-
ings of the IEEE Conference on Computer Vision and Pattern
Recognition, 2015.

[11] Chuang Gan, Zhe Gan, Xiaodong He, Jianfeng Gao, and Li
Deng. Stylenet: Generating attractive visual captions with
styles. In Proceedings of the IEEE Conference on Computer
Vision and Pattern Recognition, 2017.

[12] Yoav Goldberg and Joakim Nivre. Training deterministic
parsers with non-deterministic oracles. Transactions of the
Association of Computational Linguistics, 1:403–414, 2013.

[13] Kaiming He, Xiangyu Zhang, Shaoqing Ren, and Jian Sun.
Deep residual learning for image recognition. In Proceed-

ings of the IEEE Conference on Computer Vision and Pattern
Recognition, 2016.

[14] Matthew Honnibal, Yoav Goldberg, and Mark Johnson. A
non-monotonic arc-eager transition system for dependency
parsing.
In Proceedings of the Seventeenth Conference on
Computational Natural Language Learning, 2013.

[15] Ronghang Hu, Marcus Rohrbach, Jacob Andreas, Trevor
Darrell, and Kate Saenko. Modeling relationships in ref-
erential expressions with compositional modular networks.
In Proceedings of the IEEE Conference on Computer Vision
and Pattern Recognition, 2017.

[16] Ronghang Hu, Huazhe Xu, Marcus Rohrbach, Jiashi Feng,
Kate Saenko, and Trevor Darrell. Natural language object
retrieval. In Proceedings of the IEEE Conference on Com-
puter Vision and Pattern Recognition, 2016.

[17] Justin Johnson, Andrej Karpathy, and Li Fei-Fei. Densecap:
Fully convolutional localization networks for dense caption-
ing. In Proceedings of the IEEE Conference on Computer
Vision and Pattern Recognition, 2016.

[18] Andrej Karpathy and Li Fei-Fei. Deep visual-semantic align-
ments for generating image descriptions.
In Proceedings
of the IEEE Conference on Computer Vision and Pattern
Recognition, 2015.

[19] Ranjay Krishna, Yuke Zhu, Oliver Groth, Justin Johnson,
Kenji Hata, Joshua Kravitz, Stephanie Chen, Yannis Kalan-
tidis, Li-Jia Li, David A Shamma, Michael Bernstein, and
Li Fei-Fei. Visual Genome: Connecting Language and Vi-
sion Using Crowdsourced Dense Image Annotations. Inter-
national Journal of Computer Vision, 123(1):32–73, 2017.

[20] Harold W Kuhn. The hungarian method for the assignment
problem. Naval research logistics quarterly, 2(1-2):83–97,
1955.

[21] Chin-Yew Lin. Rouge: A package for automatic evaluation
In Text summarization branches out: Pro-

of summaries.
ceedings of the ACL Workshop, volume 8, 2004.

[22] Tsung-Yi Lin, Michael Maire, Serge Belongie, James Hays,
Pietro Perona, Deva Ramanan, Piotr Doll´ar, and C Lawrence
Zitnick. Microsoft COCO: Common Objects in Context. In
Proceedings of the European Conference on Computer Vi-
sion, 2014.

[23] Siqi Liu, Zhenhai Zhu, Ning Ye, Sergio Guadarrama, and
Kevin Murphy. Improved image captioning via policy gra-
dient optimization of spider. In Proceedings of the Interna-
tional Conference on Computer Vision, 2017.

[24] Jiasen Lu, Caiming Xiong, Devi Parikh, and Richard Socher.
Knowing when to look: Adaptive attention via a visual sen-
tinel for image captioning. In Proceedings of the IEEE Con-
ference on Computer Vision and Pattern Recognition, 2017.
[25] Jiasen Lu, Jianwei Yang, Dhruv Batra, and Devi Parikh.
Neural Baby Talk. In Proceedings of the IEEE Conference
on Computer Vision and Pattern Recognition, 2018.

[26] Christopher D Manning, Christopher D Manning, and Hin-
rich Sch¨utze. Foundations of statistical natural language
processing. MIT press, 1999.

[27] Alexander Mathews, Lexing Xie, and Xuming He. Sem-
Style: Learning to Generate Stylised Image Captions using
Unaligned Text. In Proceedings of the IEEE Conference on
Computer Vision and Pattern Recognition, 2018.

8315

tion of Complex Scenes. In Proceedings of the Conference
on Articial Intelligence, 2018.

[42] Oriol Vinyals, Alexander Toshev, Samy Bengio, and Du-
mitru Erhan. Show and tell: A neural image caption gen-
erator. In Proceedings of the IEEE Conference on Computer
Vision and Pattern Recognition, 2015.

[43] Oriol Vinyals, Alexander Toshev, Samy Bengio, and Du-
mitru Erhan. Show and Tell: Lessons Learned from the 2015
MSCOCO Image Captioning Challenge. IEEE Transactions
on Pattern Analysis and Machine Intelligence, 39(4):652–
663, 2017.

[44] Josiah Wang, Pranava Madhyastha, and Lucia Specia. Ob-
ject Counts! Bringing Explicit Detections Back into Image
Captioning. In Proceedings of the Conference of the North
American Chapter of the Association for Computational Lin-
guistics: Human Language Technologies, 2018.

[45] Liwei Wang, Alexander Schwing, and Svetlana Lazebnik.
Diverse and accurate image description using a variational
auto-encoder with an additive gaussian encoding space. In
Advances in Neural Information Processing Systems, 2017.
[46] Kelvin Xu, Jimmy Ba, Ryan Kiros, Kyunghyun Cho, Aaron
Courville, Ruslan Salakhutdinov, Richard S Zemel, and
Yoshua Bengio. Show, attend and tell: Neural image cap-
tion generation with visual attention. In Proceedings of the
International Conference on Machine Learning, 2015.

[47] Zhilin Yang, Ye Yuan, Yuexin Wu, William W Cohen, and
Ruslan R Salakhutdinov. Review networks for caption gen-
eration. In Advances in Neural Information Processing Sys-
tems, 2016.

[48] Quanzeng You, Hailin Jin, Zhaowen Wang, Chen Fang, and
Jiebo Luo. Image captioning with semantic attention. In Pro-
ceedings of the IEEE Conference on Computer Vision and
Pattern Recognition, 2016.

[49] Peter Young, Alice Lai, Micah Hodosh, and Julia Hocken-
maier. From image descriptions to visual denotations: New
similarity metrics for semantic inference over event descrip-
tions. Transactions of the Association for Computational
Linguistics, 2:67–78, 2014.

[50] Yundong Zhang, Juan Carlos Niebles, and Alvaro Soto. In-
terpretable Visual Question Answering by Visual Grounding
from Attention Supervision Mining. In Proceedings of the
IEEE Winter Conference on Applications of Computer Vi-
sion, 2018.

[28] Alexander Patrick Mathews, Lexing Xie, and Xuming He.
SentiCap: Generating Image Descriptions with Sentiments.
In Proceedings of the Conference on Articial Intelligence,
2016.

[29] Gonzalo Mena, David Belanger, Scott Linderman, and
Jasper Snoek. Learning latent permutations with gumbel-
sinkhorn networks. Proceedings of the International Confer-
ence on Learning Representations, 2018.

[30] Saul B Needleman and Christian D Wunsch. A general
method applicable to the search for similarities in the amino
acid sequence of two proteins. Journal of Molecular Biology,
48(3):443–453, 1970.

[31] Kishore Papineni, Salim Roukos, Todd Ward, and Wei-Jing
Zhu. Bleu: a method for automatic evaluation of machine
translation. In Proceedings of the 40th Annual Meeting on
Association for Computational Linguistics, 2002.

[32] Marco Pedersoli, Thomas Lucas, Cordelia Schmid, and
Jakob Verbeek. Areas of attention for image captioning. In
Proceedings of the International Conference on Computer
Vision, 2017.

[33] Jeffrey Pennington, Richard Socher, and Christopher Man-
ning. GloVe: Global vectors for word representation. In Pro-
ceedings of the Conference on Empirical Methods in Natural
Language Processing, 2014.

[34] Bryan A Plummer, Liwei Wang, Chris M Cervantes,
Juan C Caicedo, Julia Hockenmaier, and Svetlana Lazebnik.
Flickr30k entities: Collecting region-to-phrase correspon-
dences for richer image-to-sentence models. In Proceedings
of the International Conference on Computer Vision, 2015.

[35] Marc’Aurelio Ranzato, Sumit Chopra, Michael Auli, and
Wojciech Zaremba. Sequence level training with recurrent
neural networks. In Proceedings of the International Con-
ference on Learning Representations, 2015.

[36] Shaoqing Ren, Kaiming He, Ross Girshick, and Jian Sun.
Faster R-CNN: Towards real-time object detection with re-
gion proposal networks. In Advances in Neural Information
Processing Systems, 2015.

[37] Steven J Rennie, Etienne Marcheret, Youssef Mroueh, Jarret
Ross, and Vaibhava Goel. Self-critical sequence training for
image captioning. In Proceedings of the IEEE Conference
on Computer Vision and Pattern Recognition, 2017.

[38] Anna Rohrbach, Marcus Rohrbach, Ronghang Hu, Trevor
Darrell, and Bernt Schiele. Grounding of textual phrases in
images by reconstruction. In Proceedings of the European
Conference on Computer Vision, 2016.

[39] Rakshith Shetty, Marcus Rohrbach, Lisa Anne Hendricks,
Mario Fritz, and Bernt Schiele. Speaking the Same Lan-
guage: Matching Machine to Human Captions by Adversar-
ial Training. In Proceedings of the International Conference
on Computer Vision, 2017.

[40] Ramakrishna Vedantam, C Lawrence Zitnick, and Devi
Parikh. CIDEr: Consensus-based Image Description Eval-
uation. In Proceedings of the IEEE Conference on Computer
Vision and Pattern Recognition, 2015.

[41] Ashwin K Vijayakumar, Michael Cogswell, Ramprasaath R
Selvaraju, Qing Sun, Stefan Lee, David J Crandall, and
Dhruv Batra. Diverse Beam Search for Improved Descrip-

8316

